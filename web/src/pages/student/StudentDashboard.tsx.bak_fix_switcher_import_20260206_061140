import React from "react";
import { getDefaultStudent } from "../../demo/demoData";
import {
import DemoRoleSwitcher from "../../components/DemoRoleSwitcher";
  Home,
  Search,
  User2,
  ChevronDown,
  Check,
  TrendingUp,
  AlertTriangle,
  Star,
  ChevronRight,
  CheckSquare,
  Pencil,
} from "lucide-react";

function classNames(...c: Array<string | false | undefined | null>) {
  return c.filter(Boolean).join(" ");
}

function ShellCard({
  children,
  className,
}: {
  children: React.ReactNode;
  className?: string;
}) {
  return (
    <div
      className={classNames(
        "rounded-2xl bg-white/70 shadow-sm ring-1 ring-black/5 backdrop-blur",
        className
      )}
    >
      {children}
    </div>
  );
}

function Card({
  title,
  subtitle,
  icon,
  right,
  children,
  className,
}: {
  title: string;
  subtitle?: string;
  icon?: React.ReactNode;
  right?: React.ReactNode;
  children: React.ReactNode;
  className?: string;
}) {
  return (
    <ShellCard className={className}>
      <div className="p-6">
        <div className="flex items-start justify-between gap-4">
          <div>
            <div className="flex items-center gap-2">
              {icon ? <div className="text-slate-500">{icon}</div> : null}
              <div className="text-xl font-semibold text-slate-900">{title}</div>
            </div>
            {subtitle ? <div className="mt-1 text-sm text-slate-500">{subtitle}</div> : null}
          </div>
          {right}
        </div>
        <div className="mt-5">{children}</div>
      </div>
    </ShellCard>
  );
}

function ProgressPill({ value }: { value: number }) {
  const v = Math.max(0, Math.min(100, value));
  const green = Math.max(0, Math.min(100, v));
  const yellow = Math.max(0, Math.min(100, 100 - green));

  return (
    <div className="rounded-2xl bg-emerald-50/70 px-5 py-4 ring-1 ring-emerald-200/60">
      <div className="flex items-center gap-3">
        
              <DemoRoleSwitcher />
<div className="text-sm font-medium text-slate-700">
          Overall Progress: <span className="font-semibold">{v}%</span>
        </div>

        <div className="h-2 flex-1 overflow-hidden rounded-full bg-slate-200">
          <div className="flex h-full w-full">
            <div className="h-full bg-emerald-500" style={{ width: `${green}%` }} />
            <div className="h-full bg-amber-300" style={{ width: `${yellow}%` }} />
          </div>
        </div>
      </div>
    </div>
  );
}

function Donut({ percent }: { percent: number }) {
  const p = Math.max(0, Math.min(100, percent));
  const r = 54;
  const c = 2 * Math.PI * r;
  const dash = (p / 100) * c;

  return (
    <div className="relative grid place-items-center">
      <svg width="160" height="160" viewBox="0 0 160 160">
        <circle cx="80" cy="80" r={r} stroke="rgb(226 232 240)" strokeWidth="16" fill="none" />
        <circle
          cx="80"
          cy="80"
          r={r}
          stroke="rgb(34 197 94)"
          strokeWidth="16"
          fill="none"
          strokeLinecap="round"
          strokeDasharray={`${dash} ${c - dash}`}
          transform="rotate(-90 80 80)"
        />
      </svg>
      <div className="absolute text-center">
        <div className="text-4xl font-semibold text-slate-900">{Math.round(p)}%</div>
      </div>
    </div>
  );
}

function GoalSlider() {
  return (
    <div className="mt-5">
      <div className="inline-flex items-center rounded-lg bg-emerald-50 px-3 py-1 text-sm text-slate-700 ring-1 ring-emerald-200/60">
        <span className="font-medium">Goal:</span>&nbsp;Stay above 95%
      </div>

      <div className="mt-3 h-2 w-full rounded-full bg-slate-200">
        <div className="h-2 w-[78%] rounded-full bg-slate-500" />
      </div>

      <div className="mt-3 text-sm text-slate-500">
        Missing fewer than <span className="font-medium">8 days</span> keeps you on track.
      </div>
    </div>
  );
}

function TinySparkline() {
  return (
    <div className="mt-3 rounded-xl bg-slate-50 ring-1 ring-slate-200/70 p-3">
      <svg viewBox="0 0 260 70" className="h-14 w-full">
        <path
          d="M10 52 C40 48, 55 36, 80 40 C105 44, 120 28, 145 30 C170 32, 190 20, 215 24 C235 27, 245 18, 250 14"
          fill="none"
          stroke="rgb(59 130 246)"
          strokeWidth="3"
          strokeLinecap="round"
        />
        <path
          d="M10 52 C40 48, 55 36, 80 40 C105 44, 120 28, 145 30 C170 32, 190 20, 215 24 C235 27, 245 18, 250 14 L250 70 L10 70 Z"
          fill="rgba(59,130,246,0.12)"
        />
      </svg>
    </div>
  );
}

function SubjectMini({
  title,
  note,
  barClass,
  bgClass,
}: {
  title: string;
  note: string;
  barClass: string;
  bgClass: string;
}) {
  return (
    <ShellCard className={classNames("p-5", bgClass)}>
      <div className="text-lg font-semibold text-slate-900">{title}</div>
      <div className="mt-3 text-sm text-slate-600">{note}</div>
      <div className="mt-4 h-2 w-full rounded-full bg-white/60 ring-1 ring-black/5 overflow-hidden">
        <div className={classNames("h-full rounded-full", barClass)} style={{ width: "70%" }} />
      </div>
    </ShellCard>
  );
}

export default function StudentDashboard() {
  const demoStudent = getDefaultStudent();
  void demoStudent; // demo-state: prevents unused var TS error
  // mock-ish values
  const studentName = "Jordan!";
  const overallProgress = 78;

  const attendancePct = 94.2;
  const missedDays = 12;

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 via-slate-50 to-slate-100">
      <div className="mx-auto max-w-6xl px-6 py-8">
        {/* Top bar (matches mock) */}
        <div className="flex items-center justify-between gap-4">
          <div className="flex items-center gap-3">
            <div className="grid h-10 w-10 place-items-center rounded-xl bg-white shadow-sm ring-1 ring-black/5">
              <Home className="h-5 w-5 text-slate-700" />
            </div>
            <div className="text-xl font-semibold text-slate-800">Student Dashboard</div>
              <div className="rounded-full bg-amber-50 px-3 py-1 text-xs font-medium text-amber-700 ring-1 ring-amber-200">
                Demo Data
              </div>

          </div>

          <div className="flex items-center gap-3">
            <div className="hidden md:flex items-center gap-2 rounded-2xl bg-white px-4 py-2 shadow-sm ring-1 ring-black/5">
              <Search className="h-4 w-4 text-slate-500" />
              <input
                className="w-72 bg-transparent text-sm outline-none placeholder:text-slate-400"
                placeholder="Search student..."
              />
            </div>

            <button className="flex items-center gap-2 rounded-2xl bg-white px-3 py-2 shadow-sm ring-1 ring-black/5">
              <User2 className="h-5 w-5 text-slate-700" />
              <ChevronDown className="h-4 w-4 text-slate-500" />
            </button>
          </div>
        </div>

        {/* Greeting + overall progress pill */}
        <div className="mt-8 grid grid-cols-1 gap-6 lg:grid-cols-3">
          <div className="lg:col-span-2">
            <div className="text-5xl font-semibold tracking-tight text-slate-900">
              Hi {studentName} üëã
            </div>
            <div className="mt-2 text-2xl text-slate-700">You‚Äôre currently:</div>

            {/* On Track Overall banner */}
            <div className="mt-5 overflow-hidden rounded-2xl bg-white/70 shadow-sm ring-1 ring-black/5 backdrop-blur">
              <div className="bg-gradient-to-r from-emerald-700 to-emerald-600 px-6 py-5 text-white">
                <div className="flex items-center gap-3">
                  <div className="grid h-9 w-9 place-items-center rounded-full bg-white/20">
                    <Check className="h-5 w-5" />
                  </div>
                  <div className="text-3xl font-semibold">On Track Overall</div>
                </div>
              </div>
              <div className="px-6 py-4 text-lg text-slate-700">
                <span className="font-medium">Grade 7</span> ‚Ä¢{" "}
                <span className="font-medium">Homeroom B</span>
              </div>
            </div>
          </div>

          <div className="lg:pt-12">
            <ProgressPill value={overallProgress} />
          </div>
        </div>

        {/* 2x2 cards grid (matches mock) */}
        <div className="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
          {/* Attendance */}
          <Card title="Attendance">
            <div className="grid grid-cols-1 gap-6 md:grid-cols-2 md:items-center">
              <div className="flex justify-center md:justify-start">
                <Donut percent={attendancePct} />
              </div>

              <div>
                <div className="text-4xl font-semibold text-slate-900">
                  {attendancePct.toFixed(1)}%
                </div>
                <div className="mt-2 text-slate-600">
                  You‚Äôve missed <span className="font-semibold">{missedDays} days</span> this year.
                </div>

                <GoalSlider />
              </div>
            </div>
          </Card>

          {/* Testing Overview */}
          <Card title="Testing Overview" subtitle="Latest available scores">
            <div className="grid grid-cols-2 gap-4">
              <div className="rounded-xl bg-white ring-1 ring-slate-200/70 p-4">
                <div className="text-sm text-slate-600">iLearn Test</div>
                <div className="mt-1 text-3xl font-semibold text-slate-900">412</div>
                <div className="mt-2 inline-flex items-center gap-2 rounded-lg bg-emerald-50 px-2 py-1 text-sm text-emerald-700 ring-1 ring-emerald-200/60">
                  <TrendingUp className="h-4 w-4" /> 9%
                </div>
              </div>

              <div className="rounded-xl bg-white ring-1 ring-slate-200/70 p-4">
                <div className="text-sm text-slate-600">WIDA Composite</div>
                <div className="mt-1 text-3xl font-semibold text-slate-900">4.2</div>
                <div className="mt-2 inline-flex items-center rounded-lg bg-emerald-50 px-2 py-1 text-xs text-slate-600 ring-1 ring-emerald-200/60">
                  Scale: 1.0‚Äì6.0
                </div>
              </div>

              <div className="rounded-xl bg-white ring-1 ring-slate-200/70 p-4">
                <div className="text-sm text-slate-600">ELA</div>
                <div className="mt-1 text-3xl font-semibold text-slate-900">211</div>
                <div className="mt-2 inline-flex items-center gap-2 rounded-lg bg-emerald-50 px-2 py-1 text-sm text-emerald-700 ring-1 ring-emerald-200/60">
                  <TrendingUp className="h-4 w-4" /> 9%
                </div>
              </div>

              <div className="rounded-xl bg-white ring-1 ring-slate-200/70 p-4">
                <div className="text-sm text-slate-600">SAT</div>
                <div className="mt-1 text-3xl font-semibold text-slate-400">N/A</div>
                <div className="mt-2 inline-flex items-center rounded-lg bg-slate-50 px-2 py-1 text-xs text-slate-600 ring-1 ring-slate-200/70">
                  Grade 11 only
                </div>
              </div>
            </div>

            <div className="mt-4 flex items-center justify-between rounded-xl bg-white ring-1 ring-slate-200/70 px-4 py-3">
              <div className="text-sm font-semibold text-slate-800">iLearn Checkpoints</div>
              <div className="text-sm text-slate-600">388 &nbsp; 4.02 &nbsp; 415 &nbsp; 500</div>
              <ChevronRight className="h-5 w-5 text-slate-400" />
            </div>
          </Card>

          {/* Academics */}
          <Card
            title="Academics"
            icon={<Home className="h-5 w-5" />}
            right={
              <div className="grid h-8 w-8 place-items-center rounded-lg bg-emerald-50 ring-1 ring-emerald-200/60">
                <CheckSquare className="h-4 w-4 text-emerald-600" />
              </div>
            }
          >
            <div className="overflow-hidden rounded-xl ring-1 ring-slate-200/70">
              <Row label="Math" status="Improving" kind="good" />
              <Row label="Reading" status="Needs Attention" kind="warn" />
              <Row label="ELA" status="Improving" kind="good" />
              <Row label="Science" status="Steady" kind="neutral" />
            </div>
          </Card>

          {/* Testing Progress */}
          <Card title="Testing Progress" icon={<Star className="h-5 w-5" />}>
            <div className="rounded-xl bg-emerald-50/60 ring-1 ring-emerald-200/60 p-4">
              <div className="text-lg text-slate-800">
                Latest iLearn : <span className="font-semibold text-emerald-700">412</span>
              </div>
              <div className="mt-1 text-lg text-slate-800">
                On Track <span className="text-emerald-700">‚Üó</span>
              </div>

              <TinySparkline />

              <div className="mt-3 flex items-center justify-between text-sm text-slate-600">
                <div>
                  <span className="font-medium text-slate-800">PSAT:</span> 920
                </div>
                <div className="text-slate-500">SAT: Not yet (Grade 11)</div>
              </div>
            </div>

            <div className="mt-3 text-sm text-slate-500">
              You‚Äôre above this year‚Äôs benchmark. üéâ
            </div>
          </Card>
        </div>

        {/* Subject Progress row */}
        <div className="mt-6">
          <ShellCard>
            <div className="p-6">
              <div className="text-xl font-semibold text-slate-900">Subject Progress</div>
              <div className="mt-5 grid grid-cols-1 gap-4 md:grid-cols-4">
                <SubjectMini
                  title="Math"
                  note="Up since last test ‚Üó"
                  bgClass="bg-emerald-50/60"
                  barClass="bg-emerald-500"
                />
                <SubjectMini
                  title="Reading"
                  note="Dropped slightly üíß"
                  bgClass="bg-rose-50/60"
                  barClass="bg-rose-400"
                />
                <SubjectMini
                  title="ELA"
                  note="Improving üëç"
                  bgClass="bg-sky-50/60"
                  barClass="bg-sky-500"
                />
                <SubjectMini
                  title="Science"
                  note="Holding steady ‚Äî"
                  bgClass="bg-amber-50/60"
                  barClass="bg-amber-400"
                />
              </div>
            </div>
          </ShellCard>
        </div>

        {/* What You Can Do This Week */}
        <div className="mt-6">
          <ShellCard>
            <div className="p-6">
              <div className="text-xl font-semibold text-slate-900">What You Can Do This Week</div>
              <div className="mt-5 grid grid-cols-1 gap-4 md:grid-cols-2">
                <TodoItem
                  icon={<CheckSquare className="h-5 w-5 text-blue-600" />}
                  text={
                    <>
                      Practice reading <span className="font-semibold">15 minutes daily</span> üìñ
                    </>
                  }
                />
                <TodoItem
                  icon={<Pencil className="h-5 w-5 text-amber-600" />}
                  text={<>Writing support session Thursday ‚è±</>}
                />
                <TodoItem
                  icon={<CheckSquare className="h-5 w-5 text-blue-600" />}
                  text={<>Writing support session Thursday</>}
                />
                <TodoItem
                  icon={<CheckSquare className="h-5 w-5 text-emerald-600" />}
                  text={<>Aim for perfect attendance this week ‚úÖ</>}
                />
              </div>
            </div>
          </ShellCard>
        </div>
      </div>
    </div>
  );
}

function TodoItem({ icon, text }: { icon: React.ReactNode; text: React.ReactNode }) {
  return (
    <div className="flex items-center gap-3 rounded-xl bg-white/60 px-4 py-3 ring-1 ring-slate-200/70">
      <div className="grid h-9 w-9 place-items-center rounded-lg bg-slate-50 ring-1 ring-slate-200/70">
        {icon}
      </div>
      <div className="text-sm text-slate-700">{text}</div>
      <div className="ml-auto text-slate-300">‚Ä∫</div>
    </div>
  );
}

function Row({
  label,
  status,
  kind,
}: {
  label: string;
  status: string;
  kind: "good" | "warn" | "neutral";
}) {
  const icon =
    kind === "good" ? (
      <TrendingUp className="h-4 w-4 text-amber-500" />
    ) : kind === "warn" ? (
      <AlertTriangle className="h-4 w-4 text-amber-500" />
    ) : (
      <span className="text-slate-400">‚Äî</span>
    );

  return (
    <div className="flex items-center justify-between bg-white/70 px-4 py-3">
      <div className="text-base text-slate-800">{label}</div>
      <div className="flex items-center gap-2 text-sm text-slate-600">
        {icon}
        <span className="font-medium">{status}</span>
      </div>
    </div>
  );
}
